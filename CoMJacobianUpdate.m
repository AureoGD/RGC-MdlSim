function [J_CoM_LF, J_CoM_RF, J_CoM_LH, J_CoM_RH] = CoMJacobianUpdate(q)

persistent J_CoM_HAA_LF J_CoM_HFE_LF J_CoM_KFE_LF J_CoM_HAA_RF J_CoM_HFE_RF J_CoM_KFE_RF J_CoM_HAA_LH J_CoM_HFE_LH J_CoM_KFE_LH J_CoM_HAA_RH J_CoM_HFE_RH J_CoM_KFE_RH mi_1 mi_2 mi_3

if isempty(J_CoM_HAA_LF)
    J_CoM_HAA_LF = zeros(3);
    J_CoM_HFE_LF  = zeros(3);
    J_CoM_KFE_LF = zeros(3);
    
    J_CoM_HAA_RF = zeros(3);
    J_CoM_HFE_RF  = zeros(3);
    J_CoM_KFE_RF = zeros(3);
    
    J_CoM_HAA_LH = zeros(3);
    J_CoM_HFE_LH  = zeros(3);
    J_CoM_KFE_LH = zeros(3);
    
    J_CoM_HAA_RH = zeros(3);
    J_CoM_HFE_RH  = zeros(3);
    J_CoM_KFE_RH = zeros(3);
    
    mi_1 = 3.49/80.51;
    mi_2 = 4.95/80.51;
    mi_3 = 1.71/80.51;
end

% Left front leg

J_CoM_HAA_LF(2,1) = (0.605e-3 * cos(q(1)) - 0.1346e-2 * sin(q(1)));
J_CoM_HAA_LF(3,1) = (-0.605e-3 * sin(q(1)) - 0.1346e-2 * cos(q(1)));

J_CoM_HFE_LF(1,2) = (-0.144296e0 * cos(q(2)) - 0.2071e-2 * sin(q(2)));
J_CoM_HFE_LF(2,1) = (-0.7214800000e-1 * cos(q(1) - q(2)) - 0.7214800000e-1 * cos(q(1) + q(2)) - 0.1035500000e-2 * sin(q(1) + q(2)) + 0.1035500000e-2 * sin(q(1) - q(2)) - 0.111906e0 * sin(q(1)));
J_CoM_HFE_LF(2,2) = (0.7214800000e-1 * cos(q(1) - q(2)) - 0.7214800000e-1 * cos(q(1) + q(2)) - 0.1035500000e-2 * sin(q(1) + q(2)) - 0.1035500000e-2 * sin(q(1) - q(2)));;
J_CoM_HFE_LF(3,1) = (0.7214800000e-1 * sin(q(1) + q(2)) + 0.7214800000e-1 * sin(q(1) - q(2)) + 0.1035500000e-2 * cos(q(1) - q(2)) - 0.1035500000e-2 * cos(q(1) + q(2)) - 0.111906e0 * cos(q(1)));
J_CoM_HFE_LF(3,2) = (0.7214800000e-1 * sin(q(1) + q(2)) - 0.7214800000e-1 * sin(q(1) - q(2)) - 0.1035500000e-2 * cos(q(1) - q(2)) - 0.1035500000e-2 * cos(q(1) + q(2)));

J_CoM_KFE_LF(1,2) = (-0.1090150000e0 * cos(q(2) + q(3)) + 0.4214700000e-1 * sin(q(2) + q(3)) - 0.360e0 * cos(q(2)));
J_CoM_KFE_LF(1,3) = (-0.1090150000e0 * cos(q(2) + q(3)) + 0.4214700000e-1 * sin(q(2) + q(3)));
J_CoM_KFE_LF(2,1) = (-0.5450750000e-1 * cos(q(1) + q(2) + q(3)) - 0.5450750000e-1 * cos(q(1) - q(2) - q(3)) + 0.2107350000e-1 * sin(q(1) + q(2) + q(3)) - 0.2107350000e-1 * sin(q(1) - q(2) - q(3)) - 0.117219e0 * sin(q(1)) - 0.1800000000e0 * cos(q(1) + q(2)) - 0.1800000000e0 * cos(q(1) - q(2)));
J_CoM_KFE_LF(2,2) = (-0.5450750000e-1 * cos(q(1) + q(2) + q(3)) + 0.5450750000e-1 * cos(q(1) - q(2) - q(3)) + 0.2107350000e-1 * sin(q(1) + q(2) + q(3)) + 0.2107350000e-1 * sin(q(1) - q(2) - q(3)) - 0.1800000000e0 * cos(q(1) + q(2)) + 0.1800000000e0 * cos(q(1) - q(2)));
J_CoM_KFE_LF(2,3) = (-0.5450750000e-1 * cos(q(1) + q(2) + q(3)) + 0.5450750000e-1 * cos(q(1) - q(2) - q(3)) + 0.2107350000e-1 * sin(q(1) + q(2) + q(3)) + 0.2107350000e-1 * sin(q(1) - q(2) - q(3)));
J_CoM_KFE_LF(3,1) = (0.5450750000e-1 * sin(q(1) - q(2) - q(3)) + 0.5450750000e-1 * sin(q(1) + q(2) + q(3)) - 0.2107350000e-1 * cos(q(1) - q(2) - q(3)) + 0.2107350000e-1 * cos(q(1) + q(2) + q(3)) - 0.117219e0 * cos(q(1)) + 0.1800000000e0 * sin(q(1) - q(2)) + 0.1800000000e0 * sin(q(1) + q(2)));
J_CoM_KFE_LF(3,2) = (-0.5450750000e-1 * sin(q(1) - q(2) - q(3)) + 0.5450750000e-1 * sin(q(1) + q(2) + q(3)) + 0.2107350000e-1 * cos(q(1) - q(2) - q(3)) + 0.2107350000e-1 * cos(q(1) + q(2) + q(3)) - 0.1800000000e0 * sin(q(1) - q(2)) + 0.1800000000e0 * sin(q(1) + q(2)));
J_CoM_KFE_LF(3,3) = (-0.5450750000e-1 * sin(q(1) - q(2) - q(3)) + 0.5450750000e-1 * sin(q(1) + q(2) + q(3)) + 0.2107350000e-1 * cos(q(1) - q(2) - q(3)) + 0.2107350000e-1 * cos(q(1) + q(2) + q(3)));

% Right front leg

J_CoM_HAA_RF(2,1) = (-0.605e-3 * cos(q(4)) + 0.1346e-2 * sin(q(4)));
J_CoM_HAA_RF(3,1) = (-0.605e-3 * sin(q(4)) - 0.1346e-2 * cos(q(4)));

J_CoM_HFE_RF(1,2) = (-0.144296e0 * cos(q(5)) - 0.2071e-2 * sin(q(5)));
J_CoM_HFE_RF(2,1) = (0.7214800000e-1 * cos(q(4) - q(5)) + 0.7214800000e-1 * cos(q(4) + q(5)) + 0.1035500000e-2 * sin(q(4) + q(5)) - 0.1035500000e-2 * sin(q(4) - q(5)) + 0.122094e0 * sin(q(4)));
J_CoM_HFE_RF(2,2) = (-0.7214800000e-1 * cos(q(4) - q(5)) + 0.7214800000e-1 * cos(q(4) + q(5)) + 0.1035500000e-2 * sin(q(4) + q(5)) + 0.1035500000e-2 * sin(q(4) - q(5)));
J_CoM_HFE_RF(3,1) = (0.7214800000e-1 * sin(q(4) + q(5)) + 0.7214800000e-1 * sin(q(4) - q(5)) + 0.1035500000e-2 * cos(q(4) - q(5)) - 0.1035500000e-2 * cos(q(4) + q(5)) - 0.122094e0 * cos(q(4)));
J_CoM_HFE_RF(3,2) = (0.7214800000e-1 * sin(q(4) + q(5)) - 0.7214800000e-1 * sin(q(4) - q(5)) - 0.1035500000e-2 * cos(q(4) - q(5)) - 0.1035500000e-2 * cos(q(4) + q(5)));


J_CoM_KFE_RF(1,2) = (-0.1090150000e0 * cos(q(5) + q(6)) + 0.4214700000e-1 * sin(q(5) + q(6)) - 0.360e0 * cos(q(5)));
J_CoM_KFE_RF(1,3) = (-0.1090150000e0 * cos(q(5) + q(6)) + 0.4214700000e-1 * sin(q(5) + q(6)));
J_CoM_KFE_RF(2,1) = (0.5450750000e-1 * cos(q(4) + q(5) + q(6)) + 0.5450750000e-1 * cos(q(4) - q(5) - q(6)) - 0.2107350000e-1 * sin(q(4) + q(5) + q(6)) + 0.2107350000e-1 * sin(q(4) - q(5) - q(6)) + 0.116781e0 * sin(q(4)) + 0.1800000000e0 * cos(q(4) + q(5)) + 0.1800000000e0 * cos(q(4) - q(5)));
J_CoM_KFE_RF(2,2) = (0.5450750000e-1 * cos(q(4) + q(5) + q(6)) - 0.5450750000e-1 * cos(q(4) - q(5) - q(6)) - 0.2107350000e-1 * sin(q(4) + q(5) + q(6)) - 0.2107350000e-1 * sin(q(4) - q(5) - q(6)) + 0.1800000000e0 * cos(q(4) + q(5)) - 0.1800000000e0 * cos(q(4) - q(5)));
J_CoM_KFE_RF(2,3) = (0.5450750000e-1 * cos(q(4) + q(5) + q(6)) - 0.5450750000e-1 * cos(q(4) - q(5) - q(6)) - 0.2107350000e-1 * sin(q(4) + q(5) + q(6)) - 0.2107350000e-1 * sin(q(4) - q(5) - q(6)));
J_CoM_KFE_RF(3,1) = (0.5450750000e-1 * sin(q(4) - q(5) - q(6)) + 0.5450750000e-1 * sin(q(4) + q(5) + q(6)) - 0.2107350000e-1 * cos(q(4) - q(5) - q(6)) + 0.2107350000e-1 * cos(q(4) + q(5) + q(6)) - 0.116781e0 * cos(q(4)) + 0.1800000000e0 * sin(q(4) - q(5)) + 0.1800000000e0 * sin(q(4) + q(5)));
J_CoM_KFE_RF(3,2) = (-0.5450750000e-1 * sin(q(4) - q(5) - q(6)) + 0.5450750000e-1 * sin(q(4) + q(5) + q(6)) + 0.2107350000e-1 * cos(q(4) - q(5) - q(6)) + 0.2107350000e-1 * cos(q(4) + q(5) + q(6)) - 0.1800000000e0 * sin(q(4) - q(5)) + 0.1800000000e0 * sin(q(4) + q(5)));
J_CoM_KFE_RF(3,3) = (-0.5450750000e-1 * sin(q(4) - q(5) - q(6)) + 0.5450750000e-1 * sin(q(4) + q(5) + q(6)) + 0.2107350000e-1 * cos(q(4) - q(5) - q(6)) + 0.2107350000e-1 * cos(q(4) + q(5) + q(6)));

% Left hind leg

J_CoM_HAA_LH(2,1) = (0.605e-3 * cos(q(7)) + sin(q(7)) * 0.134599999999999997e-2);
J_CoM_HAA_LH(3,1) = (-0.605e-3 * sin(q(7)) + cos(q(7)) * 0.134599999999999997e-2);

J_CoM_HFE_LH(1,2) = (-0.144296e0 * cos(q(8)) + sin(q(8)) * 0.207099999999999992e-2);
J_CoM_HFE_LH(2,1) = (-0.7214800000e-1 * cos(q(7) - q(8)) - 0.7214800000e-1 * cos(q(7) + q(8)) + sin(q(7) + q(8)) * 0.103549999999999996e-2 + sin(q(7) - q(8)) * (-0.103549999999999996e-2) + sin(q(7)) * (-0.122094000000000008e0));
J_CoM_HFE_LH(2,2) = (0.7214800000e-1 * cos(q(7) - q(8)) - 0.7214800000e-1 * cos(q(7) + q(8)) + sin(q(7) + q(8)) * 0.103549999999999996e-2 + sin(q(7) - q(8)) * 0.103549999999999996e-2);
J_CoM_HFE_LH(3,1) = (0.7214800000e-1 * sin(q(7) + q(8)) + 0.7214800000e-1 * sin(q(7) - q(8)) + cos(q(7) - q(8)) * (-0.103549999999999996e-2) + cos(q(7) + q(8)) * 0.103549999999999996e-2 + cos(q(7)) * (-0.122094000000000008e0));
J_CoM_HFE_LH(3,2) = (0.7214800000e-1 * sin(q(7) + q(8)) - 0.7214800000e-1 * sin(q(7) - q(8)) + cos(q(7) - q(8)) * 0.103549999999999996e-2 + cos(q(7) + q(8)) * 0.103549999999999996e-2);


J_CoM_KFE_LH(1,2) = (-0.1090150000e0 * cos(q(8) + q(9)) + sin(q(8) + q(9)) * (-0.421469999999999970e-1) - 0.360e0 * cos(q(8)));
J_CoM_KFE_LH(1,3) = (-0.1090150000e0 * cos(q(8) + q(9)) + sin(q(8) + q(9)) * (-0.421469999999999970e-1));
J_CoM_KFE_LH(2,1) = (-0.5450750000e-1 * cos(q(7) + q(8) + q(9)) - 0.5450750000e-1 * cos(q(7) - q(8) - q(9)) + sin(q(7) + q(8) + q(9)) * (-0.210734999999999985e-1) + sin(q(7) - q(8) - q(9)) * 0.210734999999999985e-1 + sin(q(7)) * (-0.116781000000000010e0) - 0.1800000000e0 * cos(q(7) + q(8)) - 0.1800000000e0 * cos(q(7) - q(8)));
J_CoM_KFE_LH(2,2) = (-0.5450750000e-1 * cos(q(7) + q(8) + q(9)) + 0.5450750000e-1 * cos(q(7) - q(8) - q(9)) + sin(q(7) + q(8) + q(9)) * (-0.210734999999999985e-1) + sin(q(7) - q(8) - q(9)) * (-0.210734999999999985e-1) - 0.1800000000e0 * cos(q(7) + q(8)) + 0.1800000000e0 * cos(q(7) - q(8)));
J_CoM_KFE_LH(2,3) = (-0.5450750000e-1 * cos(q(7) + q(8) + q(9)) + 0.5450750000e-1 * cos(q(7) - q(8) - q(9)) + sin(q(7) + q(8) + q(9)) * (-0.210734999999999985e-1) + sin(q(7) - q(8) - q(9)) * (-0.210734999999999985e-1));
J_CoM_KFE_LH(3,1) = (0.5450750000e-1 * sin(q(7) - q(8) - q(9)) + 0.5450750000e-1 * sin(q(7) + q(8) + q(9)) + cos(q(7) - q(8) - q(9)) * 0.210734999999999985e-1 + cos(q(7) + q(8) + q(9)) * (-0.210734999999999985e-1) + cos(q(7)) * (-0.116781000000000010e0) + 0.1800000000e0 * sin(q(7) - q(8)) + 0.1800000000e0 * sin(q(7) + q(8)));
J_CoM_KFE_LH(3,2) = (-0.5450750000e-1 * sin(q(7) - q(8) - q(9)) + 0.5450750000e-1 * sin(q(7) + q(8) + q(9)) + cos(q(7) - q(8) - q(9)) * (-0.210734999999999985e-1) + cos(q(7) + q(8) + q(9)) * (-0.210734999999999985e-1) - 0.1800000000e0 * sin(q(7) - q(8)) + 0.1800000000e0 * sin(q(7) + q(8)));
J_CoM_KFE_LH(3,3) = (-0.5450750000e-1 * sin(q(7) - q(8) - q(9)) + 0.5450750000e-1 * sin(q(7) + q(8) + q(9)) + cos(q(7) - q(8) - q(9)) * (-0.210734999999999985e-1) + cos(q(7) + q(8) + q(9)) * (-0.210734999999999985e-1));

%Rigth hind leg

J_CoM_HAA_RH(2,1) = (-0.605e-3 * cos(q(10)) + sin(q(10)) * (-0.134599999999999997e-2));
J_CoM_HAA_RH(3,1) = (-0.605e-3 * sin(q(10)) + cos(q(10)) * 0.134599999999999997e-2);

J_CoM_HFE_RH(1,2) = (-0.144296e0 * cos(q(11)) + sin(q(11)) * 0.207099999999999992e-2);
J_CoM_HFE_RH(2,1) = (0.7214800000e-1 * cos(q(10) - q(11)) + 0.7214800000e-1 * cos(q(10) + q(11)) + sin(q(10) + q(11)) * (-0.103549999999999996e-2) + sin(q(10) - q(11)) * 0.103549999999999996e-2 + sin(q(10)) * 0.111906000000000005e0);
J_CoM_HFE_RH(2,2) = (-0.7214800000e-1 * cos(q(10) - q(11)) + 0.7214800000e-1 * cos(q(10) + q(11)) + sin(q(10) + q(11)) * (-0.103549999999999996e-2) + sin(q(10) - q(11)) * (-0.103549999999999996e-2));
J_CoM_HFE_RH(3,1) = (0.7214800000e-1 * sin(q(10) + q(11)) + 0.7214800000e-1 * sin(q(10) - q(11)) + cos(q(10) - q(11)) * (-0.103549999999999996e-2) + cos(q(10) + q(11)) * 0.103549999999999996e-2 + cos(q(10)) * (-0.111906000000000005e0));
J_CoM_HFE_RH(3,2) = (0.7214800000e-1 * sin(q(10) + q(11)) - 0.7214800000e-1 * sin(q(10) - q(11)) + cos(q(10) - q(11)) * 0.103549999999999996e-2 + cos(q(10) + q(11)) * 0.103549999999999996e-2);

J_CoM_KFE_RH(1,2) = (-0.1090150000e0 * cos(q(11) + q(12)) + sin(q(11) + q(12)) * (-0.421469999999999970e-1) - 0.360e0 * cos(q(11)));
J_CoM_KFE_RH(1,3) = (-0.1090150000e0 * cos(q(11) + q(12)) + sin(q(11) + q(12)) * (-0.421469999999999970e-1));
J_CoM_KFE_RH(2,1) = (0.5450750000e-1 * cos(q(10) + q(11) + q(12)) + 0.5450750000e-1 * cos(q(10) - q(11) - q(12)) + sin(q(10) + q(11) + q(12)) * 0.210734999999999985e-1 + sin(q(10) - q(11) - q(12)) * (-0.210734999999999985e-1) + sin(q(10)) * 0.117219000000000004e0 + 0.1800000000e0 * cos(q(10) + q(11)) + 0.1800000000e0 * cos(q(10) - q(11)));
J_CoM_KFE_RH(2,2) = (0.5450750000e-1 * cos(q(10) + q(11) + q(12)) - 0.5450750000e-1 * cos(q(10) - q(11) - q(12)) + sin(q(10) + q(11) + q(12)) * 0.210734999999999985e-1 + sin(q(10) - q(11) - q(12)) * 0.210734999999999985e-1 + 0.1800000000e0 * cos(q(10) + q(11)) - 0.1800000000e0 * cos(q(10) - q(11)));
J_CoM_KFE_RH(2,3) = (0.5450750000e-1 * cos(q(10) + q(11) + q(12)) - 0.5450750000e-1 * cos(q(10) - q(11) - q(12)) + sin(q(10) + q(11) + q(12)) * 0.210734999999999985e-1 + sin(q(10) - q(11) - q(12)) * 0.210734999999999985e-1);
J_CoM_KFE_RH(3,1) = (0.5450750000e-1 * sin(q(10) - q(11) - q(12)) + 0.5450750000e-1 * sin(q(10) + q(11) + q(12)) + cos(q(10) - q(11) - q(12)) * 0.210734999999999985e-1 + cos(q(10) + q(11) + q(12)) * (-0.210734999999999985e-1) + cos(q(10)) * (-0.117219000000000004e0) + 0.1800000000e0 * sin(q(10) - q(11)) + 0.1800000000e0 * sin(q(10) + q(11)));
J_CoM_KFE_RH(3,2) = (-0.5450750000e-1 * sin(q(10) - q(11) - q(12)) + 0.5450750000e-1 * sin(q(10) + q(11) + q(12)) + cos(q(10) - q(11) - q(12)) * (-0.210734999999999985e-1) + cos(q(10) + q(11) + q(12)) * (-0.210734999999999985e-1) - 0.1800000000e0 * sin(q(10) - q(11)) + 0.1800000000e0 * sin(q(10) + q(11)));
J_CoM_KFE_RH(3,3) = (-0.5450750000e-1 * sin(q(10) - q(11) - q(12)) + 0.5450750000e-1 * sin(q(10) + q(11) + q(12)) + cos(q(10) - q(11) - q(12)) * (-0.210734999999999985e-1) + cos(q(10) + q(11) + q(12)) * (-0.210734999999999985e-1));

J_CoM_LF = mi_1*J_CoM_HAA_LF+mi_2*J_CoM_HFE_LF+mi_3*J_CoM_KFE_LF;
J_CoM_RF = mi_1*J_CoM_HAA_RF+mi_2*J_CoM_HFE_RF+mi_3*J_CoM_KFE_RF;
J_CoM_LH = mi_1*J_CoM_HAA_LH+mi_2*J_CoM_HFE_LH+mi_3*J_CoM_KFE_LH;
J_CoM_RH = mi_1*J_CoM_HAA_RH+mi_2*J_CoM_HFE_RH+mi_3*J_CoM_KFE_RH;
end

